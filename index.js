const { Client, GatewayIntentBits, PermissionsBitField, ActivityType, Collection } = require('discord.js');
// Syst√®me anti-doublon pour les commandes
const processedMessages = new Set();

const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.GuildMembers, // N√©cessaire pour r√©cup√©rer les membres
        GatewayIntentBits.MessageContent, // Si vous voulez lire le contenu des messages
        GatewayIntentBits.GuildPresences, // N√©cessaire pour la commande dmonline
    ],
});

// Remplacez par une liste d'IDs des utilisateurs autoris√©s
const AUTHORIZED_USERS = ['owner_1', 'owner_2', 'owner_3'];

// Token du bot
const BOT_TOKEN = "TOKEN";

client.once('ready', () => {
    console.log(`Connect√© en tant que ${client.user.tag}`);

    // Le bot affiche une bulle verte (en ligne)
    client.user.setPresence({
        status: 'online'
    });
});

client.on('messageCreate', async (message) => {
    // Ignorer les messages des bots
    if (message.author.bot) return;

    // V√©rifier si c'est une commande
    if (message.content.startsWith('!!')) {
        // V√©rifier si le message a d√©j√† √©t√© trait√©
        const messageId = `${message.id}-${message.author.id}`;
        if (processedMessages.has(messageId)) {
            return; // Ignorer les messages d√©j√† trait√©s
        }
        
        // Marquer le message comme trait√©
        processedMessages.add(messageId);
        
        // Nettoyer le Set pour √©viter les fuites de m√©moire (apr√®s 1 minute)
        setTimeout(() => {
            processedMessages.delete(messageId);
        }, 60000);
        
        const args = message.content.slice(2).trim().split(/ +/);
        const command = args.shift().toLowerCase();

        // V√©rifier si l'utilisateur est autoris√© pour les commandes sensibles
        if (['dmall', 'dmonline', 'dmrole', 'dmembed', 'dmimage', 'status', 'setavatar', 'setname', 'help'].includes(command)) {
            if (!AUTHORIZED_USERS.includes(message.author.id)) {
                return message.reply("‚ùå Vous n'√™tes pas autoris√© √† utiliser cette commande.");
            }
        }

        // Commande `!!dmall` - Envoie un DM √† tous les membres
        if (command === 'dmall') {
            const dmMessage = args.join(' ');
            if (!dmMessage) {
                return message.reply("‚ùå Veuillez fournir un message √† envoyer.");
            }

            try {
                const members = await message.guild.members.fetch();
                let sentCount = 0;

                message.reply("‚è≥ Envoi des messages en cours...");

                for (const [, member] of members) {
                    if (!member.user.bot) {
                        const personalizedMessage = dmMessage.replace(/{user}/g, `<@${member.user.id}>`);

                        try {
                            await member.send(personalizedMessage);
                            sentCount++;
                            console.log(`‚úÖ Message envoy√© √† ${member.user.tag}`);
                        } catch (err) {
                            console.error(`‚ùå Impossible d'envoyer un message √† ${member.user.tag}: ${err}`);
                        }
                    }
                }

                message.channel.send(`‚úÖ Message envoy√© √† ${sentCount} membres.`);
            } catch (err) {
                console.error("‚ùå Erreur lors de la r√©cup√©ration des membres:", err);
                message.reply("‚ùå Une erreur s'est produite lors de l'envoi des messages.");
            }
        }

        // Commande `!dmonline` - Envoie un DM uniquement aux membres en ligne
        else if (command === 'dmonline') {
            const dmMessage = args.join(' ');
            if (!dmMessage) {
                return message.reply("‚ùå Veuillez fournir un message √† envoyer.");
            }

            try {
                const members = await message.guild.members.fetch();
                let sentCount = 0;

                message.reply("‚è≥ Envoi des messages aux membres en ligne...");

                for (const [, member] of members) {
                    if (!member.user.bot && member.presence?.status === 'online') {
                        const personalizedMessage = dmMessage.replace(/{user}/g, `<@${member.user.id}>`);

                        try {
                            await member.send(personalizedMessage);
                            sentCount++;
                            console.log(`‚úÖ Message envoy√© √† ${member.user.tag} (en ligne)`);
                        } catch (err) {
                            console.error(`‚ùå Impossible d'envoyer un message √† ${member.user.tag}: ${err}`);
                        }
                    }
                }

                message.channel.send(`‚úÖ Message envoy√© √† ${sentCount} membres en ligne.`);
            } catch (err) {
                console.error("‚ùå Erreur:", err);
                message.reply("‚ùå Une erreur s'est produite lors de l'envoi des messages.");
            }
        }

        // Commande `!dmrole` - Envoie un DM aux membres ayant un r√¥le sp√©cifique
        else if (command === 'dmrole') {
            const roleId = args[0];
            if (!roleId) {
                return message.reply("‚ùå Veuillez sp√©cifier l'ID du r√¥le: `!!dmrole <ID_ROLE> <message>`");
            }

            const dmMessage = args.slice(1).join(' ');
            if (!dmMessage) {
                return message.reply("‚ùå Veuillez fournir un message √† envoyer.");
            }

            try {
                const role = message.guild.roles.cache.get(roleId);
                if (!role) {
                    return message.reply("‚ùå R√¥le non trouv√©. V√©rifiez l'ID du r√¥le.");
                }

                const members = await message.guild.members.fetch();
                let sentCount = 0;

                message.reply(`‚è≥ Envoi des messages aux membres avec le r√¥le ${role.name}...`);

                for (const [, member] of members) {
                    if (!member.user.bot && member.roles.cache.has(roleId)) {
                        const personalizedMessage = dmMessage.replace(/{user}/g, `<@${member.user.id}>`);

                        try {
                            await member.send(personalizedMessage);
                            sentCount++;
                            console.log(`‚úÖ Message envoy√© √† ${member.user.tag} (r√¥le: ${role.name})`);
                        } catch (err) {
                            console.error(`‚ùå Impossible d'envoyer un message √† ${member.user.tag}: ${err}`);
                        }
                    }
                }

                message.channel.send(`‚úÖ Message envoy√© √† ${sentCount} membres avec le r√¥le ${role.name}.`);
            } catch (err) {
                console.error("‚ùå Erreur:", err);
                message.reply("‚ùå Une erreur s'est produite lors de l'envoi des messages.");
            }
        }

        // Commande `!dmembed` - Envoie un embed en DM √† tous les membres
        else if (command === 'dmembed') {
            const title = args[0];
            const description = args.slice(1).join(' ');

            if (!title || !description) {
                return message.reply("‚ùå Format: `!!dmembed <titre> <description>`");
            }

            try {
                const { EmbedBuilder } = require('discord.js');
                const embed = new EmbedBuilder()
                    .setColor(0x800080) // Violet fonc√©
                    .setTitle(title)
                    .setDescription(description)
                    .setTimestamp()
                    .setFooter({ text: `Envoy√© par ${message.author.tag}` });

                const members = await message.guild.members.fetch();
                let sentCount = 0;

                message.reply("‚è≥ Envoi des embeds en cours...");

                for (const [, member] of members) {
                    if (!member.user.bot) {
                        // Personnalisation pour chaque utilisateur
                        const personalizedEmbed = EmbedBuilder.from(embed)
                            .setDescription(description.replace(/{user}/g, `<@${member.user.id}>`));

                        try {
                            await member.send({ embeds: [personalizedEmbed] });
                            sentCount++;
                            console.log(`‚úÖ Embed envoy√© √† ${member.user.tag}`);
                        } catch (err) {
                            console.error(`‚ùå Impossible d'envoyer un embed √† ${member.user.tag}: ${err}`);
                        }
                    }
                }

                message.channel.send(`‚úÖ Embed envoy√© √† ${sentCount} membres.`);
            } catch (err) {
                console.error("‚ùå Erreur:", err);
                message.reply("‚ùå Une erreur s'est produite lors de l'envoi des embeds.");
            }
        }

        // Commande `!help` - Affiche toutes les commandes disponibles
        else if (command === 'help') {
            const { EmbedBuilder } = require('discord.js');

            const helpEmbed = new EmbedBuilder()
                .setColor(0x800080) // Violet fonc√©
                .setTitle('Commandes disponibles')
                .setDescription('Voici la liste des commandes disponibles :')
                .addFields(
                    { name: 'üì® Commandes de message', value: 
                        '`!!dmall <message>` - Envoie un message priv√© √† tous les membres\n' +
                        '`!!dmonline <message>` - Envoie un message priv√© aux membres en ligne\n' +
                        '`!!dmrole <ID_ROLE> <message>` - Envoie un message priv√© aux membres d\'un r√¥le\n' +
                        '`!!dmembed <titre> <description>` - Envoie un embed √† tous les membres\n' +
                        '`!!dmimage <URL_IMAGE> [texte]` - Envoie une image √† tous les membres'
                    },
                    { name: '‚öôÔ∏è Commandes de gestion', value: 
                        '`!!status <texte>` - Change le statut du bot\n' +
                        '`!!setavatar <URL_IMAGE>` - Change l\'avatar du bot\n' +
                        '`!!setname <nouveau_nom>` - Change le nom du bot\n' +
                        '`!!stats` - Affiche les statistiques du bot\n' +
                        '`!!server` - Affiche les commandes utiles du serveur'
                    },
                    { name: 'üí° Astuce', value: 'Utilisez {user} dans vos messages pour mentionner l\'utilisateur qui re√ßoit le message.' }
                )
                .setFooter({ text: 'Bot DM Manager' })
                .setTimestamp();

            return message.channel.send({ embeds: [helpEmbed] });
        }
        
        // Commande `!server` - Affiche les commandes utiles du serveur
        else if (command === 'server') {
            const { EmbedBuilder } = require('discord.js');
            
            const serverEmbed = new EmbedBuilder()
                .setColor(0x800080) // Violet fonc√©
                .setTitle('üìö Guide du Serveur')
                .setDescription('Bienvenue sur le serveur! Voici quelques commandes et informations utiles:')
                .addFields(
                    { name: 'üõ†Ô∏è Commandes Discord Utiles', value: 
                        '`/nick <nouveau_pseudo>` - Change ton pseudo\n' +
                        '`/userinfo <@utilisateur>` - Voir les infos d\'un utilisateur\n' +
                        '`/afk <raison>` - Indique que tu es AFK\n' +
                        '`/role` - G√©rer tes r√¥les personnalis√©s'
                    },
                    { name: 'üîî Notifications', value: 
                        '‚Ä¢ Cliquez sur le nom du canal -> Notifications -> Tous les messages / Mentions seulement\n' +
                        '‚Ä¢ Utilisez `/roleinfo` pour voir les r√¥les √† mention\n' +
                        '‚Ä¢ D√©sactivez les @everyone et @here dans vos param√®tres'
                    },
                    { name: 'ü§ù R√®gles Importantes', value: 
                        '‚Ä¢ Soyez respectueux envers tous les membres\n' +
                        '‚Ä¢ Pas de spam ou de publicit√© non autoris√©e\n' +
                        '‚Ä¢ Utilisez les canaux appropri√©s pour vos messages\n' +
                        '‚Ä¢ Suivez les directives de Discord (ToS)'
                    },
                    { name: 'üîó Liens Utiles', value: 
                        '‚Ä¢ [Invitation du serveur](https://discord.gg/chitanda)\n' +
                        '‚Ä¢ [Site du serveur](https://discord.gg/chitanda)\n' +
                        '‚Ä¢ [Charte des r√®gles compl√®tes](https://discord.gg/chitanda)'
                    }
                )
                .setImage('https://media.discordapp.net/attachments/973918931771756564/988823071530274876/divider2.gif')
                .setFooter({ text: 'Pour plus d\'informations, contactez le staff' })
                .setTimestamp();
                
            return message.channel.send({ embeds: [serverEmbed] });
        }

        // Commandes de gestion du bot

        // Commande `!status` - Change le statut du bot
        else if (command === 'status') {
            if (!args[0]) {
                return message.reply("‚ùå Format: `!!status <texte>`");
            }

            const statusText = args.join(' ');
            client.user.setActivity(statusText, { type: ActivityType.Streaming, url: "https://twitch.tv/chitanda" });
            message.reply(`‚úÖ Statut du bot mis √† jour: Streaming **${statusText}**`);
        }

        // Commande `!setavatar` - Change l'avatar du bot
        else if (command === 'setavatar') {
            if (!args[0]) {
                return message.reply("‚ùå Format: `!!setavatar <URL_IMAGE>`");
            }

            try {
                await client.user.setAvatar(args[0]);
                message.reply("‚úÖ Avatar du bot mis √† jour avec succ√®s!");
            } catch (error) {
                console.error("‚ùå Erreur lors de la mise √† jour de l'avatar:", error);
                message.reply("‚ùå Erreur lors de la mise √† jour de l'avatar. V√©rifiez l'URL ou r√©essayez plus tard.");
            }
        }

        // Commande `!setname` - Change le nom du bot
        else if (command === 'setname') {
            if (!args[0]) {
                return message.reply("‚ùå Format: `!!setname <nouveau_nom>`");
            }

            const newName = args.join(' ');
            try {
                await client.user.setUsername(newName);
                message.reply(`‚úÖ Nom du bot chang√© en: **${newName}**`);
            } catch (error) {
                console.error("‚ùå Erreur lors du changement de nom:", error);
                message.reply("‚ùå Erreur lors du changement de nom. Les changements de nom sont limit√©s par Discord, r√©essayez plus tard.");
            }
        }

        // Commande `!stats` - Affiche les statistiques du bot
        else if (command === 'stats') {
            const { EmbedBuilder } = require('discord.js');

            const uptime = formatUptime(client.uptime);
            const serverCount = client.guilds.cache.size;
            const memberCount = client.guilds.cache.reduce((acc, guild) => acc + guild.memberCount, 0);

            const statsEmbed = new EmbedBuilder()
                .setColor(0x00FF00)
                .setTitle('üìä Statistiques du Bot')
                .addFields(
                    { name: '‚è±Ô∏è Uptime', value: uptime, inline: true },
                    { name: 'üåê Serveurs', value: serverCount.toString(), inline: true },
                    { name: 'üë• Utilisateurs', value: memberCount.toString(), inline: true },
                    { name: 'üèì Ping', value: `${client.ws.ping}ms`, inline: true },
                    { name: 'üß† M√©moire', value: `${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)} MB`, inline: true }
                )
                .setFooter({ text: `ID: ${client.user.id}` })
                .setTimestamp();

            message.channel.send({ embeds: [statsEmbed] });
        }

        // Commande `!dmimage` - Envoie une image en DM √† tous les membres
        else if (command === 'dmimage') {
            const imageUrl = args[0];
            const text = args.slice(1).join(' ');

            if (!imageUrl) {
                return message.reply("‚ùå Format: `!!dmimage <URL_IMAGE> [texte optionnel]`");
            }

            try {
                const members = await message.guild.members.fetch();
                let sentCount = 0;

                message.reply("‚è≥ Envoi des images en cours...");

                for (const [, member] of members) {
                    if (!member.user.bot) {
                        const personalizedText = text ? text.replace(/{user}/g, `<@${member.user.id}>`) : '';

                        try {
                            await member.send({
                                content: personalizedText,
                                files: [{ attachment: imageUrl }]
                            });
                            sentCount++;
                            console.log(`‚úÖ Image envoy√©e √† ${member.user.tag}`);
                        } catch (err) {
                            console.error(`‚ùå Impossible d'envoyer une image √† ${member.user.tag}: ${err}`);
                        }
                    }
                }

                message.channel.send(`‚úÖ Image envoy√©e √† ${sentCount} membres.`);
            } catch (err) {
                console.error("‚ùå Erreur:", err);
                message.reply("‚ùå Une erreur s'est produite lors de l'envoi des images.");
            }
        }
    }
});

// Fonction pour formater le temps d'activit√© du bot
function formatUptime(ms) {
    const seconds = Math.floor((ms / 1000) % 60);
    const minutes = Math.floor((ms / (1000 * 60)) % 60);
    const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
    const days = Math.floor(ms / (1000 * 60 * 60 * 24));

    return `${days}j ${hours}h ${minutes}m ${seconds}s`;
}

// Connecter le bot
client.login(BOT_TOKEN);
